<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme - SepetDolu</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; min-height: 95vh; }
        .page-container { display: flex; flex-wrap: wrap; gap: 40px; max-width: 900px; width: 100%; }
        .column { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .summary-column { flex: 1; min-width: 300px; }
        .payment-column { flex: 2; min-width: 400px; }
        h2 { color: #333; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-top: 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .cart-item:last-child { border-bottom: none; }
        .item-details { display: flex; align-items: center; }
        .item-details img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .item-name { font-weight: bold; }
        .item-quantity { color: #666; }
        .item-price { font-weight: bold; }
        .total-section { text-align: right; margin-top: 20px; font-size: 1.2em; font-weight: bold; }
        form input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .expiry-cvc-group { display: flex; gap: 15px; }
        .expiry-cvc-group input { flex: 1; }
        button { display: block; width: 100%; padding: 12px 20px; background-color: #FF6A15; color: white; border: none; cursor: pointer; font-size: 18px; border-radius: 5px; margin-top: 10px; }
        button:hover { background-color: #FF6A15; }
        .error { color: #dc3545; margin-bottom: 15px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Sipariş Özeti Sütunu -->
        <div class="column summary-column">
            <h2>Sipariş Özeti</h2>
            <div class="cart-summary">
                {% for item in cart %}
                <div class="cart-item">
                    <div class="item-details">
                        <img src="{{ item.image }}" alt="{{ item.name }}">
                        <div>
                            <div class="item-name">{{ item.name }}</div>
                            <div class="item-quantity">{{ item.quantity }} adet</div>
                        </div>
                    </div>
                    <div class="item-price">{{ "%.2f"|format(item.price * item.quantity) }} TL</div>
                </div>
                {% endfor %}
            </div>
            <div class="total-section">
                Toplam: {{ "%.2f"|format(total_price) }} TL
            </div>
        </div>

        <!-- Ödeme Bilgileri Sütunu -->
        <div class="column payment-column">
            <h2>Ödeme Bilgileri</h2>
            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}
            <form id="paymentForm" action="{{ url_for('buy') }}" method="POST">
                <input type="text" name="cardUser" placeholder="Kart Üzerindeki İsim" pattern="[a-zA-ZçÇğĞıİöÖşŞüÜ\s]+" title="Lütfen sadece harf giriniz." required>
                <input type="text" id="cardNumber" name="cardNumber" placeholder="Kart Numarası (16 Hane)" inputmode="numeric" required>
                <div class="expiry-cvc-group">
                    <input type="text" id="expiry" name="cardExpiry" placeholder="AA/YY" maxlength="5" required>
                    <input type="text" id="ccv" name="cardCCV" placeholder="CVC" inputmode="numeric" maxlength="4" required>
                </div>
                <button type="submit">Devam Et</button>
            </form>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('paymentForm');
        const cardNumberInput = document.getElementById("cardNumber");
        const expiryInput = document.getElementById("expiry");
        const ccvInput = document.getElementById("ccv");

        cardNumberInput.addEventListener("input", (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 16);
            // Her 4 haneden sonra standart olan tek tireyi (--) ekle
            let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1--');
            e.target.value = formattedValue;
        });

        expiryInput.addEventListener("input", (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 4);
            if (value.length > 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Form gönderilmeden önce basit kontroller ekleyelim
        form.addEventListener('submit', function(e) {
            // 1. Kart Numarası uzunluk kontrolü
            const rawCardNumber = cardNumberInput.value.replace(/-/g, '');
            if (rawCardNumber.length !== 16) {
                alert('Lütfen geçerli bir 16 haneli kart numarası giriniz.');
                e.preventDefault(); // Formu göndermeyi engelle
                return;
            }

            // 2. Son Kullanma Tarihi format kontrolü
            const expiryValue = expiryInput.value;
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiryValue)) {
                alert('Lütfen son kullanma tarihini AA/YY formatında giriniz (örn: 08/25).');
                e.preventDefault();
                return;
            }

            // 3. CVC/CVV uzunluk kontrolü
            if (ccvInput.value.length < 3) {
                alert('CVC/CVV kodu en az 3 haneli olmalıdır.');
                e.preventDefault();
                return;
            }
        });
    </script>
</body>
</html>